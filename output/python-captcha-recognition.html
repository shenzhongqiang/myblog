
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

    <link rel="stylesheet" type="text/css" href="https://www.shenzhongqiang.com/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="https://www.shenzhongqiang.com/theme/pygments/github.min.css">
  <link rel="stylesheet" type="text/css" href="https://www.shenzhongqiang.com/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="https://www.shenzhongqiang.com/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="https://www.shenzhongqiang.com/theme/font-awesome/css/solid.css">


    <link href="https://www.shenzhongqiang.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="强哥的世界 Atom">


    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
    <link rel="manifest" href="/images/site.webmanifest">


<meta name="author" content="Zhongqiang Shen" />
<meta name="description" content="很多网站登录都需要输入验证码，如果要实现自动登录就不可避免的要识别验证码。最近学习了一下图像处理相关的知识，并用Python实现了基于KNN的验证码识别。 准备工作 …" />
<meta name="keywords" content="Python, 图像处理">

<meta property="og:site_name" content="强哥的世界"/>
<meta property="og:title" content="用Python识别验证码"/>
<meta property="og:description" content="很多网站登录都需要输入验证码，如果要实现自动登录就不可避免的要识别验证码。最近学习了一下图像处理相关的知识，并用Python实现了基于KNN的验证码识别。 准备工作 …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://www.shenzhongqiang.com/python-captcha-recognition.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2018-08-28 00:00:00+08:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://www.shenzhongqiang.com/author/zhongqiang-shen.html">
<meta property="article:section" content="图像处理"/>
<meta property="article:tag" content="Python"/>
<meta property="article:tag" content="图像处理"/>
<meta property="og:image" content="">

  <title>强哥的世界 &ndash; 用Python识别验证码</title>

</head>
<body>
  <aside>
    <div>
      <a href="https://www.shenzhongqiang.com">
        <img src="https://www.shenzhongqiang.com/theme/img/qiangge.jpg" alt="强哥的世界" title="强哥的世界">
      </a>
      <h1><a href="https://www.shenzhongqiang.com">强哥的世界</a></h1>

<p>技术 | 生活 | 摄影</p>
      <nav>
        <ul class="list">
          <li>
            <a href="https://www.shenzhongqiang.com/pages/about.html">关于我</a>
          </li>
        </ul>
        <ul class="social">
          <li>
            <a data-title="www.zhihu.com/people/shenzhongqiang" href="https://www.zhihu.com/people/shenzhongqiang" target="_blank">
              <svg class="icon icon-zhihu" viewBox="0 0 120 120" width="100%" height="100%">
                <path d="M53.29 80.035l7.32.002 2.41 8.24 13.128-8.24h15.477v-67.98H53.29v67.978zm7.79-60.598h22.756v53.22h-8.73l-8.718 5.473-1.587-5.46-3.72-.012v-53.22zM46.818 43.162h-16.35c.545-8.467.687-16.12.687-22.955h15.987s.615-7.05-2.68-6.97H16.807c1.09-4.1 2.46-8.332 4.1-12.708 0 0-7.523 0-10.085 6.74-1.06 2.78-4.128 13.48-9.592 24.41 1.84-.2 7.927-.37 11.512-6.94.66-1.84.785-2.08 1.605-4.54h9.02c0 3.28-.374 20.9-.526 22.95H6.51c-3.67 0-4.863 7.38-4.863 7.38H22.14C20.765 66.11 13.385 79.24 0 89.62c6.403 1.828 12.784-.29 15.937-3.094 0 0 7.182-6.53 11.12-21.64L43.92 85.18s2.473-8.402-.388-12.496c-2.37-2.788-8.768-10.33-11.496-13.064l-4.57 3.627c1.363-4.368 2.183-8.61 2.46-12.71H49.19s-.027-7.38-2.372-7.38z"></path>
              </svg>
            </a>
          </li>
          <li>
            <a data-title="个人微信" href="https://www.shenzhongqiang.com/pages/wechat.html" target="_blank">
              <svg class="icon icon-wechat" viewBox="0 0 27 27" width="100%" height="100%">
                <path d="M21.502 19.525c1.524-1.105 2.498-2.738 2.498-4.554 0-3.326-3.237-6.023-7.229-6.023s-7.229 2.697-7.229 6.023c0 3.327 3.237 6.024 7.229 6.024.825 0 1.621-.117 2.36-.33l.212-.032c.139 0 .265.043.384.111l1.583.914.139.045c.133 0 .241-.108.241-.241l-.039-.176-.326-1.215-.025-.154c0-.162.08-.305.202-.392zm-12.827-17.228c-4.791 0-8.675 3.236-8.675 7.229 0 2.178 1.168 4.139 2.997 5.464.147.104.243.276.243.471l-.03.184-.391 1.458-.047.211c0 .16.13.29.289.29l.168-.054 1.899-1.097c.142-.082.293-.133.46-.133l.255.038c.886.255 1.842.397 2.832.397l.476-.012c-.188-.564-.291-1.158-.291-1.771 0-3.641 3.542-6.593 7.911-6.593l.471.012c-.653-3.453-4.24-6.094-8.567-6.094zm5.686 11.711c-.532 0-.963-.432-.963-.964 0-.533.431-.964.963-.964.533 0 .964.431.964.964 0 .532-.431.964-.964.964zm4.82 0c-.533 0-.964-.432-.964-.964 0-.533.431-.964.964-.964.532 0 .963.431.963.964 0 .532-.431.964-.963.964zm-13.398-5.639c-.639 0-1.156-.518-1.156-1.156 0-.639.517-1.157 1.156-1.157.639 0 1.157.518 1.157 1.157 0 .638-.518 1.156-1.157 1.156zm5.783 0c-.639 0-1.156-.518-1.156-1.156 0-.639.517-1.157 1.156-1.157.639 0 1.157.518 1.157 1.157 0 .638-.518 1.156-1.157 1.156z"></path>
              </svg>
            </a>
          </li>
          <li>
            <a data-title="github.com/shenzhongqiang" href="https://github.com/shenzhongqiang" target="_blank">
              <svg class="icon icon-github" viewBox="0 0 1024 1024" width="100%" height="100%">
                <path d="M674.816 579.021c-36.762 0-66.56 41.318-66.56 92.109 0 50.893 29.798 92.211 66.56 92.211s66.56-41.318 66.56-92.211c-0.051-50.79-29.798-92.109-66.56-92.109zM906.547 339.251c7.629-18.688 7.936-124.877-32.512-226.611 0 0-92.723 10.189-233.011 106.496-29.44-8.192-79.258-12.186-128.973-12.186-49.818 0-99.584 3.994-129.024 12.186-140.339-96.307-233.062-106.496-233.062-106.496-40.397 101.734-39.987 207.923-32.461 226.611-47.514 51.61-76.544 113.613-76.544 198.195 0 367.923 305.306 373.811 382.31 373.811 17.51 0 52.122 0.102 88.781 0.102 36.608 0 71.27-0.102 88.678-0.102 77.107 0 382.31-5.888 382.31-373.811 0-84.582-28.979-146.586-76.493-198.195zM513.434 866.048h-2.867c-193.075 0-343.501-22.989-343.501-210.688 0-45.005 15.872-86.682 53.606-121.293 62.822-57.702 169.216-27.187 289.894-27.187 0.512 0 1.024 0 1.485 0 0.512 0 0.922 0 1.382 0 120.678 0 227.123-30.515 289.997 27.187 37.632 34.611 53.504 76.288 53.504 121.293 0 187.699-150.374 210.688-343.501 210.688zM349.235 579.021c-36.762 0-66.56 41.318-66.56 92.109 0 50.893 29.798 92.211 66.56 92.211 36.813 0 66.611-41.318 66.611-92.211 0-50.79-29.798-92.109-66.611-92.109z"></path>
              </svg>
            </a>
          </li>
          <li>
            <a data-title="linkedin.com/in/shenzhongqiang" href="http://linkedin.com/in/shenzhongqiang" target="_blank">
              <svg class="icon icon-linkedin" viewBox="0 0 600 600" width="100%" height="100%">
                <path d="M409.391,511.359V317.203c0,0-5.75-51.938-56-51.938c-50.219,0-59.406,49.375-59.406,49.375v196.719h-103.5l1.688-320.719   h100.125l-0.813,40.313c0,0,20.876-52.688,99.531-52.688c78.625,0,114.25,45.188,120.875,129.688c0,84.531,0,203.406,0,203.406   H409.391z M63.547,145.078c-35.563,0-64.438-25.438-64.438-56.875s28.875-56.938,64.438-56.938s64.438,25.5,64.438,56.938   S99.109,145.078,63.547,145.078z M127.422,511.734H0.172V191.453l127.25-0.813V511.734z"></path>
              </svg>
            </a>
          </li>
        </ul>
      </nav>

    </div>


  </aside>
  <main>

<article class="single">
  <header>
      
    <h3 id="yong-pythonshi-bie-yan-zheng-ma">用Python识别验证码</h3>
    <p>
          发表于 2018-08-28 分类: <a href="https://www.shenzhongqiang.com/category/tu-xiang-chu-li.html">图像处理</a>


      <span id="busuanzi_container_page_pv">
        &#8226; 阅读 <span id="busuanzi_value_page_pv"></span>次
      </span>
        &#8226; 阅读时间 21分钟
    </p>
  </header>

  <div>
    <p>很多网站登录都需要输入验证码，如果要实现自动登录就不可避免的要识别验证码。最近学习了一下图像处理相关的知识，并用Python实现了基于KNN的验证码识别。</p>
<h4>准备工作</h4>
<p>这里我们使用opencv做图像处理，所以需要安装下面两个库</p>
<div class="highlight"><pre><span></span>pip3 install opencv-python
pip3 install numpy
</pre></div>


<h4>识别原理</h4>
<p>我们采取一种有监督式学习的方法来识别验证码，包含以下几个步骤</p>
<ol>
<li>
<ul>
<li>图片处理 - 对图片进行降噪、二值化处理</li>
</ul>
</li>
<li>
<ul>
<li>切割图片 - 将图片切割成单个字符并保存</li>
</ul>
</li>
<li>
<ul>
<li>人工标注 - 对切割的字符图片进行人工标注，作为训练集</li>
</ul>
</li>
<li>
<ul>
<li>训练数据 - 用KNN算法训练数据</li>
</ul>
</li>
<li>
<ul>
<li>检测结果 - 用上一步的训练结果识别新的验证码 </li>
</ul>
</li>
</ol>
<p>下面我们来逐一介绍一下每一步的过程，并给出具体的代码实现。</p>
<h4>图片处理</h4>
<p>先来看一下我们要识别的验证码是长什么样的</p>
<p><img alt="" src="https://www.shenzhongqiang.com/images/v2-31446645e951c0e68abd7d7d14fa430d_b.jpg"></p>
<p>可以看到，字符做了一些扭曲变换。仔细观察，还可以发现图片中间的部分添加了一些颗粒化的噪声。</p>
<p>我们先读入图片，并将图片转成灰度图，代码如下</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">cv2</span>

<span class="n">im</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
<span class="n">im_gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
</pre></div>


<p>经过上面的处理，我们的彩色图片变成了下面这样</p>
<p><img alt="" src="https://www.shenzhongqiang.com/images/v2-6d3eddb56a9bc41f46c94d94b01260a8_b.jpg"></p>
<p>将图片做二值化处理，代码如下</p>
<div class="highlight"><pre><span></span><span class="n">ret</span><span class="p">,</span> <span class="n">im_inv</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">im_gray</span><span class="p">,</span><span class="mi">127</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_BINARY_INV</span><span class="p">)</span>
</pre></div>


<p>127是我们设定的阈值，像素值大于127被置成了0，小于127的被置成了255。处理后的图片变成了这样</p>
<p><img alt="" src="https://www.shenzhongqiang.com/images/v2-751db8147c0fa40b3b84952a95259e28_b.jpg"></p>
<p>接下来，我们应用高斯模糊对图片进行降噪。高斯模糊的本质是用高斯核和图像做卷积，代码如下</p>
<div class="highlight"><pre><span></span><span class="n">kernel</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">16</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">im_blur</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">filter2D</span><span class="p">(</span><span class="n">im_inv</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">kernel</span><span class="p">)</span>
</pre></div>


<p>降噪后的图片如下</p>
<p><img alt="" src="https://www.shenzhongqiang.com/images/v2-5c7452974f157b5ac236881585ac7c1d_b.jpg"></p>
<p>可以看到一些颗粒化的噪声被平滑掉了。</p>
<p>降噪后，我们对图片再做一轮二值化处理</p>
<div class="highlight"><pre><span></span><span class="n">ret</span><span class="p">,</span> <span class="n">im_res</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">im_blur</span><span class="p">,</span><span class="mi">127</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_BINARY</span><span class="p">)</span>
</pre></div>


<p>现在图片变成了这样</p>
<p><img alt="" src="https://www.shenzhongqiang.com/images/v2-f999fac3774088ffa885e04195e0a454_b.jpg"></p>
<p>好了，接下来，我们要开始切割图片了。</p>
<h4>切割图片</h4>
<p>这一步是所有步骤里最复杂的一步。我们的目标是把最开始的图片切割成单个字符，并把每个字符保存成如下的灰度图</p>
<p><img alt="" src="https://www.shenzhongqiang.com/images/v2-d0cdb5294de1759d683eeedb622f6b7a_r.jpg"></p>
<p>首先我们用opencv的findContours来提取轮廓</p>
<div class="highlight"><pre><span></span><span class="n">im2</span><span class="p">,</span> <span class="n">contours</span><span class="p">,</span> <span class="n">hierarchy</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span><span class="n">im_res</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">RETR_EXTERNAL</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CHAIN_APPROX_SIMPLE</span><span class="p">)</span>
</pre></div>


<p>我们把提取的轮廓用矩形框起来，画出来是这样的</p>
<p><img alt="" src="https://www.shenzhongqiang.com/images/v2-7f07b7d2aa8d803471f52664dd05fbab_b.jpg"></p>
<p>可以看到，每个字符都被检测出来了。</p>
<p>但这只是理想情况，很多时候，相邻字符有粘连的会被识别成同一个字符，比如像下面的情况</p>
<p><img alt="" src="https://www.shenzhongqiang.com/images/v2-cd3b9e91630784bba2ef3157b08e0cac_b.jpg"></p>
<p>要处理这种情况，我们就要对上面的图片做进一步的分割。字符粘连会有下面几种情况，我们逐一来看下该怎么处理。</p>
<p><strong>4个字符被识别成3个字符</strong></p>
<p><img alt="" src="https://www.shenzhongqiang.com/images/v2-cd3b9e91630784bba2ef3157b08e0cac_b.jpg"></p>
<p>这种情况，对粘连的字符轮廓，从中间进行分割，代码如下</p>
<div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">contour</span> <span class="ow">in</span> <span class="n">contours</span><span class="p">:</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">w</span> <span class="o">==</span> <span class="n">w_max</span><span class="p">:</span> <span class="c1"># w_max是所有contonur的宽度中最宽的值</span>
        <span class="n">box_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int0</span><span class="p">([[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">]])</span>
        <span class="n">box_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int0</span><span class="p">([[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="p">,</span><span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">]])</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box_left</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box_right</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int0</span><span class="p">([[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="p">,</span><span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">]])</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
</pre></div>


<p>分割后，图片变成了这样</p>
<p><img alt="" src="https://www.shenzhongqiang.com/images/v2-babc84a88f37da47da7159ae22e34f31_b.jpg"></p>
<p><strong>4个字符被识别成2个字符</strong></p>
<p>4个字符被识别成2个字符有下面两种情况</p>
<p><img alt="" src="https://www.shenzhongqiang.com/images/v2-187e74d0a8d8b5414aaa934fd7054284_b.jpg"></p>
<p><img alt="" src="https://www.shenzhongqiang.com/images/v2-15879049649299892e61f0971a28a38b_b.jpg"></p>
<p>对第一种情况，对于左右两个轮廓，从中间分割即可。对第二种情况，将包含了3个字符的轮廓在水平方向上三等分。具体代码如下</p>
<div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">contour</span> <span class="ow">in</span> <span class="n">contours</span><span class="p">:</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">w</span> <span class="o">==</span> <span class="n">w_max</span> <span class="ow">and</span> <span class="n">w_max</span> <span class="o">&gt;=</span> <span class="n">w_min</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># 如果两个轮廓一个是另一个的宽度的2倍以上，我们认为这个轮廓就是包含3个字符的轮廓</span>
        <span class="n">box_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int0</span><span class="p">([[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span><span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">]])</span>
        <span class="n">box_mid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int0</span><span class="p">([[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span><span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="o">*</span><span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span><span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="o">*</span><span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">]])</span>
        <span class="n">box_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int0</span><span class="p">([[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="o">*</span><span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span><span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="p">,</span><span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="o">*</span><span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">]])</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box_left</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box_mid</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box_right</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">w_max</span> <span class="o">&lt;</span> <span class="n">w_min</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># 如果两个轮廓，较宽的宽度小于较窄的2倍，我们认为这是两个包含2个字符的轮廓</span>
        <span class="n">box_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int0</span><span class="p">([[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">]])</span>
        <span class="n">box_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int0</span><span class="p">([[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="p">,</span><span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">]])</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box_left</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box_right</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int0</span><span class="p">([[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="p">,</span><span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">]])</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
</pre></div>


<p>分割后的图片如下</p>
<p><img alt="" src="https://www.shenzhongqiang.com/images/v2-578701cc257689d14fe84f6fb9df2d62_b.jpg"></p>
<p><img alt="" src="https://www.shenzhongqiang.com/images/v2-5e04eea87da684bf2481e50d7fb6e048_b.jpg"></p>
<p><strong>4个字符被识别成1个字符</strong></p>
<p><img alt="" src="https://www.shenzhongqiang.com/images/v2-271af704e06dc806b026d985d080c5c1_b.jpg"></p>
<p>这种情况对轮廓在水平方向上做4等分即可，代码如下</p>
<div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">contour</span> <span class="o">=</span> <span class="n">contours</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">(</span><span class="n">contour</span><span class="p">)</span>
<span class="n">box0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int0</span><span class="p">([[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span><span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">]])</span>
<span class="n">box1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int0</span><span class="p">([[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span><span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="o">*</span><span class="mi">2</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span><span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="o">*</span><span class="mi">2</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">]])</span>
<span class="n">box2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int0</span><span class="p">([[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="o">*</span><span class="mi">2</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span><span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="o">*</span><span class="mi">3</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span><span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="o">*</span><span class="mi">3</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="o">*</span><span class="mi">2</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">]])</span>
<span class="n">box3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int0</span><span class="p">([[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="o">*</span><span class="mi">3</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span><span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="p">,</span><span class="n">y</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">],</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="o">*</span><span class="mi">3</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">]])</span>
<span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">box0</span><span class="p">,</span> <span class="n">box1</span><span class="p">,</span> <span class="n">box2</span><span class="p">,</span> <span class="n">box3</span><span class="p">])</span>
</pre></div>


<p>分割后的图片如下</p>
<p><img alt="" src="https://www.shenzhongqiang.com/images/v2-15ff4149212238374a65663cc43a6c0d_b.jpg"></p>
<p>对图片分割完成后，我们将分割后的单个字符的图片存成不同的图片文件，以便下一步做人工标注。存取字符图片的代码如下</p>
<div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">drawContours</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="p">[</span><span class="n">box</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">roi</span> <span class="o">=</span> <span class="n">im_res</span><span class="p">[</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span><span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">roistd</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">roi</span><span class="p">,</span> <span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span> <span class="c1"># 将字符图片统一调整为30x30的图片大小</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">)</span> <span class="c1"># 为防止文件重名，使用时间戳命名文件名</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;{}.jpg&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
    <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;char&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">roistd</span><span class="p">)</span>
</pre></div>


<p>字符图片保存在名为char的目录下面，这个目录里的文件大致是长这样的（文件名用时间戳命名，确保不会重名）</p>
<p><img alt="" src="https://www.shenzhongqiang.com/images/v2-afa4bb501db945b1277d14accde00ed7_r.jpg"></p>
<p>接下来，我们开始标注数据。</p>
<h4>人工标注</h4>
<p>这一步是所有步骤里最耗费体力的一步了。为节省时间，我们在程序里依次打开char目录中的每张图片，键盘输入字符名，程序读取键盘输入并将字符名保存在文件名里。代码如下</p>
<div class="highlight"><pre><span></span><span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s2">&quot;char&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
    <span class="n">filename_ts</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">patt</span> <span class="o">=</span> <span class="s2">&quot;label/{}_*&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename_ts</span><span class="p">)</span>
    <span class="n">saved_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">patt</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">saved_num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{} done&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">patt</span><span class="p">))</span>
        <span class="k">continue</span>
    <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;char&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="n">im</span><span class="p">)</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">27</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">13</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">char</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">filename_ts</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">outfile</span> <span class="o">=</span> <span class="s2">&quot;{}_{}.jpg&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename_ts</span><span class="p">,</span> <span class="n">char</span><span class="p">)</span>
    <span class="n">outpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="n">im</span><span class="p">)</span>
</pre></div>


<p>这里一共标注了大概800张字符图片，标注的结果存在名为label的目录下，目录下的文件是这样的（文件名由原文件名+标注名组成）</p>
<p><img alt="" src="https://www.shenzhongqiang.com/images/v2-10d64f3d3f320fdf79896efa4a30a85d_r.jpg"></p>
<p>接下来，我们开始训练数据。</p>
<h4>训练数据</h4>
<p>首先，我们从label目录中加载已标注的数据</p>
<div class="highlight"><pre><span></span><span class="n">filenames</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">900</span><span class="p">))</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
    <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">900</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">unique_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>
<span class="n">unique_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">)))</span>
<span class="n">label_id_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">,</span> <span class="n">unique_ids</span><span class="p">))</span>
<span class="n">id_label_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">unique_ids</span><span class="p">,</span> <span class="n">unique_labels</span><span class="p">))</span>
<span class="n">label_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">label_id_map</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">labels</span><span class="p">))</span>
<span class="n">label_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">label_ids</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</pre></div>


<p>接下来，训练我们的模型</p>
<div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">ml</span><span class="o">.</span><span class="n">KNearest_create</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">ml</span><span class="o">.</span><span class="n">ROW_SAMPLE</span><span class="p">,</span> <span class="n">label_ids</span><span class="p">)</span>
</pre></div>


<p>训练完，我们用这个模型来识别一下新的验证码。</p>
<h4>检测结果</h4>
<p>下面是我们要识别的验证码</p>
<p><img alt="" src="https://www.shenzhongqiang.com/images/v2-bc9650c5fa46140d9a8eb1661e07ccc7_b.jpg"></p>
<p>对于每一个要识别的验证码，我们都需要对图片做降噪、二值化、分割的处理（代码和上面的一样，这里不再重复）。假设处理后的图片存在变量im_res中，分割后的字符的轮廓信息存在变量boxes中，识别验证码的代码如下</p>
<div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">boxes</span><span class="p">:</span>
    <span class="n">roi</span> <span class="o">=</span> <span class="n">im_res</span><span class="p">[</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span><span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">roistd</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">roi</span><span class="p">,</span> <span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">roistd</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">900</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">ret</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">neighbours</span><span class="p">,</span> <span class="n">distances</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">findNearest</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">label_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">id_label_map</span><span class="p">[</span><span class="n">label_id</span><span class="p">]</span>
    <span class="k">print</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</pre></div>


<p>运行上面的代码，可以看到程序输出</p>
<div class="highlight"><pre><span></span>y
y
4
e
</pre></div>


<p>图片中的验证码被成功地识别出来。</p>
<p>我们测试了下识别的准确率，取100张验证码图片（存在test目录下）进行识别，识别的准确率约为82%。看到有人说用神经网络识别验证码，准确率可以达到90%以上，下次有机会可以尝试一下。</p>
<p>完整代码已上传github：<a href="http://link.zhihu.com/?target=https%3A//github.com/pythonml/captacha">pythonml/captacha</a> </p>
<p>所有训练数据、测试数据、已标注图片都已上传百度网盘，公众号【<strong>Python与数据分析</strong>】后台回复“验证码”可获取网盘地址。</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://www.shenzhongqiang.com/tag/python.html">Python</a>
      <a href="https://www.shenzhongqiang.com/tag/tu-xiang-chu-li.html">图像处理</a>
    </p>
  </div>




</article>

    <footer>
<p>&copy; Zhongqiang Shen 2018</p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p>    </footer>
    <script type="text/javascript">
      var cnzz_protocol = (("https:" == document.location.protocol) ? "https://" : "http://");
      document.write(unescape("%3Cspan id='cnzz_stat_icon_1276445513'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s23.cnzz.com/stat.php%3Fid%3D1276445513%26show%3Dpic2' type='text/javascript'%3E%3C/script%3E"));
    </script>
  </main>

<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " 强哥的世界 ",
  "url" : "https://www.shenzhongqiang.com",
  "image": "",
  "description": ""
}
</script>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
  </script>
</body>
</html>